<!DOCTYPE html>
<!--[if lte IE 6]><html class="preIE7 preIE8 preIE9"><![endif]-->
<!--[if IE 7]><html class="preIE8 preIE9"><![endif]-->
<!--[if IE 8]><html class="preIE9"><![endif]-->
<!--[if gte IE 9]><!--><html><!--<![endif]-->
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Adjacent County</title>
    <meta name="author" content="name">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
       integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
       crossorigin="" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.min.css" type="text/css" />
    <link rel="stylesheet" href="stylesheet.css" type="text/css" />
  </head>
  <body>
    <div id="loading-cover">
      <span>Loading...</span>
    </div>
    <div id="map-wrapper"></div>
    <div id="search-wrapper">
      <input id="search" type="search" placeholder="County"></input>
    </div>
    <div id="results-wrapper">
      <table>
        <thead><tr><th><a href="#" id="export" download="">Download</a>&nbsp;Name</th><th>State</th><th>Population</th><th>Housing Units</th><th>Area (sq mi)</th></thead>
        <tbody id="result"></tbody>
        <tbody id="neighbors"></tbody>
      </table>
    </div>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.5/turf.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.min.js"></script>
    <script>
    var counties, showResult, findNeighbors, restyle, countyLayer, neighbors, zoomToFeature;

    var map = new L.Map('map-wrapper', { center: new L.LatLng(39.828175, -98.5795), zoom: 5 });
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

    $.getJSON('data/counties.json', data => {
      counties = data;

      new Awesomplete($('#search')[0], {
      	list: counties.features.map(c => `${c.properties.NAME}, ${c.properties.USPS}`)
      });

      countyLayer = L.geoJSON(data, {
        onEachFeature: function(feature, layer){
          layer.on({
            click: e => {
              $('#loading-cover').fadeIn(e2 => {
                zoomToFeature(e.target.feature);
                showResult(e.target.feature);
                findNeighbors(e.target.feature);
                $('#loading-cover').fadeOut();
              });
            },
            mouseover: e => {
              e.target.openPopup();
            }
          });
        }
      })
      .bindPopup(layer => `${layer.feature.properties.NAME}, ${layer.feature.properties.USPS}`)
      .addTo(map);

      $('#search').on('awesomplete-selectcomplete', function(){
        let county, state;
        [county, state] = this.value.split(', ');
        let feature = counties.features.find(c => c.properties.NAME == county && c.properties.USPS == state);
        zoomToFeature(feature);
        showResult(feature);
        findNeighbors(feature);
        $('#loading-cover').fadeOut();
      });

      zoomToFeature = function(feature){
        map.setView(L.latLng(feature.properties.LAT, feature.properties.LON), 8);
      };

      showResult = function(n){
        $('#result').slideUp(function(){
          $(this).html(
            '<tr>' +
            ['NAME', 'USPS'].map(v => {
              return '<td>' + n.properties[v] + '</td>'
            }).join('') +
            ['POPULATION', 'HU10', 'CENSUSAREA'].map(v => {
              return '<td>' + n.properties[v].toLocaleString() + '</td>'
            }).join('') +
            '</tr>'
          ).slideDown();
        });
        $('#export').attr('download', 'Neighbors_of_' + n.properties.NAME.replace(/ /g, '_') + '_' + n.properties.USPS + '.csv');
      };

      findNeighbors = function(feature){
        neighbors = counties.features.filter(c => turf.booleanOverlap(c, feature));
        $('#neighbors').slideUp(function(){
          $(this).html(
            neighbors.map(n => {
              return '<tr>' +
              ['NAME', 'USPS'].map(v => {
                return '<td>' + n.properties[v] + '</td>'
              }).join('') +
              ['POPULATION', 'HU10', 'CENSUSAREA'].map(v => {
                return '<td>' + n.properties[v].toLocaleString() + '</td>'
              }).join('') +
              '</tr>';
            }).join('\n')
          ).slideDown();
        })
      };

    }).done(e => {
      $('#loading-cover').fadeOut();
    });

    $('#export').on('mousedown', function(e){
      let headers = 'NAME,STATE,POPULATION,HOUSINGUNITS,AREA(SQMI)';
      let content = $('#neighbors tr').map(function(){
        return $(this).find('td').map(function(){
          return $(this).text().replace(/,/g,'')
        }).get().join(',')
      }).get().join('\r\n');
      $(this).attr('href', 'data:text/csv;charset=utf-8,' + headers + '\n' + content);
    });

    </script>
  </body>
</html>
